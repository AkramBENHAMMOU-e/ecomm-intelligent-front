<section class="product-list">
  <!-- Carrousel Produits Populaires -->
  <app-popular-carousel
    *ngIf="popularProducts.length > 0"
    [products]="popularProducts">
  </app-popular-carousel>

  <div class="products-header">
    <h2>Tous les Produits</h2>
    <button class="filter-btn" (click)="openFilterSidebar()">
      <span>üîç</span> Filtres
      <span *ngIf="getActiveFiltersCount() > 0" class="filter-count">{{ getActiveFiltersCount() }}</span>
    </button>
  </div>

  <!-- Indicateur des filtres actifs -->
  <div class="active-filters" *ngIf="getActiveFiltersCount() > 0">
    <div class="active-filters-header">
      <button class="clear-all-filters-btn" (click)="clearFilters()">
        Effacer tout
      </button>
    </div>
    <div class="active-filters-list">
      <!-- Filtres par origine -->
      <div class="filter-tag" *ngFor="let origin of getActiveFilterValues('origin')">
        <span class="filter-tag-label">Origine: {{ origin }}</span>
        <button class="filter-tag-remove" (click)="removeFilterValue('origin', origin)">√ó</button>
      </div>
      
      <!-- Filtres par niveau de torr√©faction -->
      <div class="filter-tag" *ngFor="let roastLevel of getActiveFilterValues('roastLevel')">
        <span class="filter-tag-label">Torr√©faction: {{ roastLevel }}</span>
        <button class="filter-tag-remove" (click)="removeFilterValue('roastLevel', roastLevel)">√ó</button>
      </div>
      
      <!-- Filtres par marque -->
      <div class="filter-tag" *ngFor="let brand of getActiveFilterValues('brand')">
        <span class="filter-tag-label">Marque: {{ brand }}</span>
        <button class="filter-tag-remove" (click)="removeFilterValue('brand', brand)">√ó</button>
      </div>
      
      <!-- Filtres par r√©gion -->
      <div class="filter-tag" *ngFor="let region of getActiveFilterValues('region')">
        <span class="filter-tag-label">R√©gion: {{ region }}</span>
        <button class="filter-tag-remove" (click)="removeFilterValue('region', region)">√ó</button>
      </div>
      
      <!-- Filtres par processus -->
      <div class="filter-tag" *ngFor="let process of getActiveFilterValues('process')">
        <span class="filter-tag-label">Processus: {{ process }}</span>
        <button class="filter-tag-remove" (click)="removeFilterValue('process', process)">√ó</button>
      </div>
      
      <!-- Filtre par prix -->
      <div class="filter-tag" *ngIf="hasPriceFilter()">
        <span class="filter-tag-label">Prix: {{ getPriceFilterText() }}</span>
        <button class="filter-tag-remove" (click)="removePriceFilter()">√ó</button>
      </div>
    </div>
  </div>

  <div *ngIf="loading || searchLoading" class="status">Chargement des produits...</div>
  <div *ngIf="error" class="status error">{{ error }}</div>

  <!-- Etat vide pour aucune correspondance -->
  <div *ngIf="!loading && !searchLoading && !error && products.length === 0" class="status">
    Aucun produit ne correspond aux crit√®res s√©lectionn√©s.
  </div>

  <div class="products-grid" *ngIf="!loading && !searchLoading && !error && products.length > 0">
    <div class="product-card" *ngFor="let p of products">
      <a [routerLink]="['/product', p.id]" class="product-link">
        <img [src]="p.image" [alt]="p.name" class="product-card-image" appImageFallback />
        <div class="product-card-content">
          <h3 class="product-card-title">{{ p.name }}</h3>
          <p class="product-card-description">{{ p.description }}</p>
          <div class="product-meta">
            <span class="product-origin">{{ p.origin }}</span>
            <span class="product-roast-level">{{ p.roastLevel }}</span>
            <span class="product-card-price">{{ p.price | currency:'DH':'symbol':'1.2-2' }}</span>
          </div>
          
        <!-- Rating display -->
        <div class="product-rating" *ngIf="getProductRating(p)">
          <div class="rating-stars">
            <span *ngFor="let star of [1,2,3,4,5]"
                  [class]="star <= getProductRating(p)! ? 'star filled' : 'star empty'">
              ‚òÖ
            </span>
          </div>
          <span class="rating-value">{{ getProductRating(p) | number:'1.1-1' }}</span>
        </div>
        </div>
      </a>
      <div class="product-card-actions">
        <div class="quantity-input">
          <label class="qty-label">Quantit√©</label>
          <input type="number" min="1" max="99" value="1" [(ngModel)]="quantities[p.id]" (ngModelChange)="updateQuantity(p.id, $event)" class="form-input form-input-sm" placeholder="1" />
        </div>
        <button type="button" (click)="addToCart(p)" [disabled]="adding[p.id]" class="btn-primary btn-sm">
          {{ adding[p.id] ? 'Ajout...' : 'Ajouter au panier' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination-container" *ngIf="!loading && !searchLoading && !error && totalPages > 1">
    <div class="pagination-info">
      <span>Page {{ currentPageNumber + 1 }} sur {{ totalPages }}</span>
      <span class="total-elements">({{ totalElements }} produits au total)</span>
    </div>
    
    <div class="pagination-controls">
      <!-- Bouton Pr√©c√©dent -->
      <button 
        type="button" 
        (click)="goToPreviousPage()" 
        [disabled]="currentPageNumber === 0"
        class="pagination-btn pagination-btn-prev">
        <span>‚Äπ</span> Pr√©c√©dent
      </button>

      <!-- Num√©ros de page -->
      <div class="pagination-numbers">
        <button 
          *ngFor="let page of getPageNumbers()" 
          type="button"
          (click)="goToPage(page)"
          [class.active]="page === currentPageNumber"
          [class.ellipsis]="page === -1"
          class="pagination-number"
          [disabled]="page === -1">
          {{ page === -1 ? '...' : page + 1 }}
        </button>
      </div>

      <!-- Bouton Suivant -->
      <button 
        type="button" 
        (click)="goToNextPage()" 
        [disabled]="currentPageNumber === totalPages - 1"
        class="pagination-btn pagination-btn-next">
        Suivant <span>‚Ä∫</span>
      </button>
    </div>
  </div>

  <!-- Quick order panel -->
  <div class="overlay" *ngIf="panelOpen" (click)="closePanel()"></div>
  <div class="panel" *ngIf="panelOpen">
    <button class="close" (click)="closePanel()">‚úï</button>
    <ng-container *ngIf="selected as s">
      <div class="panel-header">
        <img [src]="s.image" [alt]="s.name" appImageFallback />
        <div>
          <h3>{{ s.name }}</h3>
          <p class="price">{{ s.price | currency:'DH':'symbol':'1.2-2' }}</p>
        </div>
      </div>
      <div class="panel-body">
        <label>Quantit√©
          <input type="number" min="1" [(ngModel)]="qty" />
        </label>
        <p class="error" *ngIf="panelError">{{ panelError }}</p>
        <div class="panel-actions">
          <button (click)="addSelectedToCart()">Ajouter au panier</button>
          <button class="primary" (click)="buyNow()" [disabled]="placing">
            {{ placing ? 'Commande en cours...' : 'Commander maintenant' }}
          </button>
        </div>
        <div class="success" *ngIf="lastOrder">
          Commande #{{ lastOrder.id }} cr√©√©e avec succ√®s.
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Cart Sidebar -->
  <div class="overlay" *ngIf="cartSidebarOpen" (click)="closeCartSidebar()"></div>
  <aside class="cart-sidebar" *ngIf="cartSidebarOpen">
    <button class="close" (click)="closeCartSidebar()">‚úï</button>
    <h3>Votre panier</h3>

    <ng-container *ngIf="cart?.items?.length; else emptyCart">
      <div class="cart-items">
        <div class="cart-item" *ngFor="let it of cart?.items">
          <div class="info">
            <div class="name">{{ it.product.name }}</div>
            <div class="meta">{{ it.product.price | currency:'DH':'symbol':'1.2-2' }} √ó {{ it.quantity }}</div>
          </div>
          <div class="quantity-controls">
            <button class="qty-btn" (click)="updateCartItemQuantity(it, it.quantity - 1)">-</button>
            <span class="qty-display">{{ it.quantity }}</span>
            <button class="qty-btn" (click)="updateCartItemQuantity(it, it.quantity + 1)">+</button>
            <button class="remove-btn" (click)="removeItemFromCart(it)">‚úï</button>
          </div>
          <div class="subtotal">{{ ((it.product.price||0) * (it.quantity||0)) | currency:'DH':'symbol':'1.2-2' }}</div>
        </div>
      </div>
      <div class="cart-footer">
        <div class="total"><span>Total:</span><strong>{{ cartTotal | currency:'DH':'symbol':'1.2-2' }}</strong></div>
        <a class="checkout-btn" routerLink="/checkout" (click)="closeCartSidebar()">Aller √† la commande</a>
      </div>
    </ng-container>

    <ng-template #emptyCart>
      <p class="empty">Votre panier est vide.</p>
    </ng-template>
  </aside>

  <!-- Filter Sidebar -->
  <div class="overlay" *ngIf="filterSidebarOpen" (click)="closeFilterSidebar()"></div>
  <aside class="filter-sidebar" *ngIf="filterSidebarOpen">
    <div class="filter-header">
      <h3>Filtres</h3>
      <button class="close" (click)="closeFilterSidebar()">‚úï</button>
    </div>

    <div class="filter-content">
      <!-- Filtre par origine -->
      <div class="filter-section">
        <label>Origine</label>
        <div class="checkbox-group">
          <label *ngFor="let option of originOptions" class="checkbox-item">
            <input 
              type="checkbox" 
              [value]="option.value"
              [checked]="isFilterValueSelected('origin', option.value)"
              (change)="onCheckboxChange('origin', option.value, $any($event.target).checked)"
              class="checkbox">
            <span>{{ option.label }}</span>
          </label>
        </div>
      </div>

      <!-- Filtre par niveau de torr√©faction -->
      <div class="filter-section">
        <label>Niveau de torr√©faction</label>
        <div class="checkbox-group">
          <label *ngFor="let option of roastLevelOptions" class="checkbox-item">
            <input 
              type="checkbox" 
              [value]="option.value"
              [checked]="isFilterValueSelected('roastLevel', option.value)"
              (change)="onCheckboxChange('roastLevel', option.value, $any($event.target).checked)"
              class="checkbox">
            <span>{{ option.label }}</span>
          </label>
        </div>
      </div>

      <!-- Filtre par marque -->
      <div class="filter-section">
        <label>Marque</label>
        <div class="checkbox-group">
          <label *ngFor="let option of brandOptions" class="checkbox-item">
            <input 
              type="checkbox" 
              [value]="option.value"
              [checked]="isFilterValueSelected('brand', option.value)"
              (change)="onCheckboxChange('brand', option.value, $any($event.target).checked)"
              class="checkbox">
            <span>{{ option.label }}</span>
          </label>
        </div>
      </div>

      <!-- Filtre par r√©gion -->
      <div class="filter-section">
        <label>R√©gion</label>
        <div class="checkbox-group">
          <label *ngFor="let option of regionOptions" class="checkbox-item">
            <input 
              type="checkbox" 
              [value]="option.value"
              [checked]="isFilterValueSelected('region', option.value)"
              (change)="onCheckboxChange('region', option.value, $any($event.target).checked)"
              class="checkbox">
            <span>{{ option.label }}</span>
          </label>
        </div>
      </div>

      <!-- Filtre par processus -->
      <div class="filter-section">
        <label>Processus</label>
        <div class="checkbox-group">
          <label *ngFor="let option of processOptions" class="checkbox-item">
            <input 
              type="checkbox" 
              [value]="option.value"
              [checked]="isFilterValueSelected('process', option.value)"
              (change)="onCheckboxChange('process', option.value, $any($event.target).checked)"
              class="checkbox">
            <span>{{ option.label }}</span>
          </label>
        </div>
      </div>

      <!-- Filtre par prix -->
      <div class="filter-section">
        <label>Prix ({{ minPrice | currency:'DH':'symbol':'1.0-0' }} - {{ maxPrice | currency:'DH':'symbol':'1.0-0' }})</label>
        <div class="price-range">
          <input 
            type="range" 
            [min]="priceRange.min" 
            [max]="priceRange.max" 
            [(ngModel)]="minPrice"
            (ngModelChange)="onPriceRangeChange()"
            class="price-slider">
          <input 
            type="range" 
            [min]="priceRange.min" 
            [max]="priceRange.max" 
            [(ngModel)]="maxPrice"
            (ngModelChange)="onPriceRangeChange()"
            class="price-slider">
        </div>
        <div class="price-display">
          <span>{{ minPrice | currency:'DH':'symbol':'1.0-0' }}</span>
          <span> - </span>
          <span>{{ maxPrice | currency:'DH':'symbol':'1.0-0' }}</span>
        </div>
      </div>

      <!-- Boutons d'action -->
      <div class="filter-actions">
        <button class="btn-secondary" (click)="clearFilters()">Effacer</button>
        <button class="btn-primary" (click)="applyFilters()" [disabled]="searchLoading">
          {{ searchLoading ? 'Recherche...' : 'Appliquer' }}
        </button>
      </div>
    </div>
  </aside>
</section>
