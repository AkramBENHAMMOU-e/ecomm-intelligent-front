<section class="product-list">
  <h2>Produits</h2>

  <!-- Barre de recherche -->
  <div class="search-bar" *ngIf="!loading">
    <input
      type="text"
      [(ngModel)]="searchTerm"
      placeholder="Rechercher un produit (nom, catégorie, description)"
    />
  </div>

  <div *ngIf="loading" class="status">Chargement des produits...</div>
  <div *ngIf="error" class="status error">{{ error }}</div>

  <!-- Etat vide pour aucune correspondance -->
  <div *ngIf="!loading && !error && filteredProducts.length === 0" class="status">
    Aucun produit ne correspond à "{{ searchTerm }}".
  </div>

  <div class="grid" *ngIf="!loading && !error && filteredProducts.length > 0">
    <div class="card" *ngFor="let p of filteredProducts">
      <a [routerLink]="['/product', p.id]" class="product-link">
        <img [src]="p.image" [alt]="p.name" class="image" />
        <div class="body">
          <h3 class="name">{{ p.name }}</h3>
          <p class="desc">{{ p.description }}</p>
          <div class="meta">
            <span class="category">{{ p.category }}</span>
            <span class="price">{{ p.price | currency:'DH':'symbol':'1.2-2' }}</span>
          </div>
        </div>
      </a>
      <div class="actions">
        <label class="qty-label">Qté
          <input type="number" min="1" max="99" value="1" [(ngModel)]="quantities[p.id]" (ngModelChange)="updateQuantity(p.id, $event)" placeholder="1" />
        </label>
        <button type="button" (click)="addToCart(p)" [disabled]="adding[p.id]" class="add-btn">
          {{ adding[p.id] ? 'Ajout...' : 'Ajouter au panier' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Quick order panel -->
  <div class="overlay" *ngIf="panelOpen" (click)="closePanel()"></div>
  <div class="panel" *ngIf="panelOpen">
    <button class="close" (click)="closePanel()">✕</button>
    <ng-container *ngIf="selected as s">
      <div class="panel-header">
        <img [src]="s.image" [alt]="s.name" />
        <div>
          <h3>{{ s.name }}</h3>
          <p class="price">{{ s.price | currency:'DH':'symbol':'1.2-2' }}</p>
        </div>
      </div>
      <div class="panel-body">
        <label>Quantité
          <input type="number" min="1" [(ngModel)]="qty" />
        </label>
        <p class="error" *ngIf="panelError">{{ panelError }}</p>
        <div class="panel-actions">
          <button (click)="addSelectedToCart()">Ajouter au panier</button>
          <button class="primary" (click)="buyNow()" [disabled]="placing">
            {{ placing ? 'Commande en cours...' : 'Commander maintenant' }}
          </button>
        </div>
        <div class="success" *ngIf="lastOrder">
          Commande #{{ lastOrder.id }} créée avec succès.
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Cart Sidebar -->
  <div class="overlay" *ngIf="cartSidebarOpen" (click)="closeCartSidebar()"></div>
  <aside class="cart-sidebar" *ngIf="cartSidebarOpen">
    <button class="close" (click)="closeCartSidebar()">✕</button>
    <h3>Votre panier</h3>

    <ng-container *ngIf="cart?.items?.length; else emptyCart">
      <div class="cart-items">
        <div class="cart-item" *ngFor="let it of cart?.items">
          <div class="info">
            <div class="name">{{ it.product.name }}</div>
            <div class="meta">{{ it.product.price | currency:'DH':'symbol':'1.2-2' }} × {{ it.quantity }}</div>
          </div>
          <div class="quantity-controls">
            <button class="qty-btn" (click)="updateCartItemQuantity(it, it.quantity - 1)">-</button>
            <span class="qty-display">{{ it.quantity }}</span>
            <button class="qty-btn" (click)="updateCartItemQuantity(it, it.quantity + 1)">+</button>
            <button class="remove-btn" (click)="removeItemFromCart(it)">✕</button>
          </div>
          <div class="subtotal">{{ ((it.product.price||0) * (it.quantity||0)) | currency:'DH':'symbol':'1.2-2' }}</div>
        </div>
      </div>
      <div class="cart-footer">
        <div class="total"><span>Total:</span><strong>{{ cartTotal | currency:'DH':'symbol':'1.2-2' }}</strong></div>
        <a class="checkout-btn" routerLink="/checkout" (click)="closeCartSidebar()">Aller à la commande</a>
      </div>
    </ng-container>

    <ng-template #emptyCart>
      <p class="empty">Votre panier est vide.</p>
    </ng-template>
  </aside>
</section>
